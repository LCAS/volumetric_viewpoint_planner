# MoveIt2 Commander for Robot Arms in Plant Inspection

Arm target pose command generator, based on lattice viewpoints using Moveit2 Move Group Interface, part fo Agri-open Core (AOC) project

The defaults settings is for **Franka Emika Panda Robots** and **Flir Blackfly_s** cameras.

This package is developed for **ROS2 humble** release

# Getting Started 

Clone the repository and build it

```bash
mkdir -p ${your_ws}/src 
cd ${your_ws}/src
git clone --branch humble-dev git@github.com:{owner}/moveit2_commander_recorder.git
cd moveit2_commander_recorder && git checkout humble-dev
cd ${your_ws} && colcon build
source install/setup.bash
```

# Generate Moveit Commands for the Arm (Default is Franka Arm)

Run the following launch file to generate pose commands for the arm using MoveIt2 based on viewpoints' poses (including point positions and orientations)

```bash
ros2 launch moveit2_commander_recorder moveit_commander.launch.py
```
<img src="docs/Franka-LatticePoses-Moveit2.gif" width="1200" >

1. The input is lattice poses (viewpoints) generated by [viewpoint_generator](https://github.com/LCAS/volumetric_viewpoint_planner/tree/main/src/viewpoint_generator) package
2. The output is next pose message (geometry_msgs/PoseStamped) sent to the arm (over **/arm_next_node_pose** topic)

# Capture images from Arm Tool Frame Camera

In addition to generate next pose message, when the arm reaches its target pose, camera image can be captured and recorded through image_view package. To enable image capture property, set relevant parameter true.

3. The images are captured through **/image** topic when **/save** service is called, using the camera information on **/camera_info** topic. It automatically happens when this node is run. Images will be recorded when the robot arm reaches each target pose. In addition to images, a ".csv" file including image_tag and capture_pose (XYZ, RPY) information about the images is also saved.

# Configuration of Nodes

In config folder, **parameters.yaml** can be used to configure the node. 

## Commander node parameters

* **"move_group_name_"** parameter for choosing move group name defined in your robot arm, for example for the Franka arm it can be "panda_arm", "hand", "panda_arm_hand" or "panda_vision"
* **"pose_command_seq_type"** parameter for choosing how to send lattice poses. "all" means that all lattice points will be sent in an order. "random" means that one of the lattice points will be selected randomly and to be sent as target pose

* Please note that the pose commands will be generated according to the defined frameID in the lattice pose array message

* **"move_group_planning_time_"** parameter for setting the time allowed to work on planning for moveit move_group node. Default value is 10.0 secs.
* **"move_group_max_vel_scale_"** parameter for setting max allowed velocity scale factor for planning of moveit move_group node. Default value is 0.05. 
* **"move_group_num_planning_attempts_"** parameter for setting the number of planning attempts for moveit move_group node. Default value is 2.

* **"capture_images_"** parameter for deciding whether images to be captured or not. Default value is True.

* **"pre_delay_"** parameter for choosing how many secs pre_delay will be inserted before capturing image through tool frame camera. It is used to ensure robot arm reaches its steady-state. Default value is 2.0 secs.
* **"post_delay_"** parameter for choosing how many secs post_delay will be inserted after capturing image through tool frame camera. It is used to ensure robot arm starts next movement after capturing images. Default value is 0.0 secs.

* **"image_info_record_sub_directory_"** parameter for choosing where to record csv file including information about the captured images. Default is "", meaning that current directory.
    
* **"image_info_record_file_name_"** parameter for choosing the name of csv file that will include information about the captured images. Default name is "image_info".

* **"ref_frameID_"** parameter for choosing the reference plant frame ID for image capturing. Default is "plant".

* **"camera_frameID_"** parameter for choosing the camera frame ID, which is mounted to the arm for image capturing. Default is "camera".

## Image saver node parameters

* **"save_all_image"** parameter for choosing whether image_saver node saves all camera messages as an image or not. If it sets to False, the image is only captured when the save service called.
* **"encoding"** parameter for choosing image encoding type, default is "bgr8".
* **"filename_format"** parameter for choosing where (current directory + given path here) the captured images will be stored. Default is img%04d.%s".
